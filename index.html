<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Javier Jimenez Shaw">
    <style>
        body { font-family: Lato,proxima-nova,Helvetica Neue,Arial,sans-serif; color: #202020 }
        thead { font-weight: bold; }
        th { cursor: pointer; }
        td:nth-child(1) { padding-left: 0.25em; padding-right: 0.25em; }
        label { white-space: nowrap; }

        #mapid { height: 400px; width: 800px; max-width: 80%; }
        .sticky { position: sticky; top: 0; }
        .area { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; width: 20em; display: block; }
        .hide { display: none;}
        .codelink { text-decoration: none; }
        .odd { background-color: #EEEEEE; }
        .order { color: #777; font-size: small; padding-left: 0.5em; }
        .loader-text { padding-left: 2em; color: darkred;}
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>

<body onload="load()">
    <h1>PROJ <span id="proj_version">8.1.1</span> codes</h1>
    <div>This page shows a list of the Coordinate Reference Systems included in <a href="https://proj.org" target="_blank">PROJ</a>.
         <span id="version_link"></span>
         <br>You can filter by type, authority, name and location (clicking on the map).
         <br>Selecting the area of use of any CRS displays it as a rectangle in the map.
         <br>Visit the source code in <a href="https://github.com/jjimenezshaw/crs-explorer" target="_blank">GitHub</a>.
    </div>
    <br>
    <div id="mapcont"><div id="mapid"></div></div>

    <div><label title="Keeps the map always visible"><input type="checkbox" id="stickyCb">Sticky map</label> |
        Click the map to select a location. <button type="button" id="delete">Delete location</button> <span id="location"></span></div>

    <div id="filters"></div>
    <div><span id="authorities"></span><span class='loader-text'>Loading...</span></div>
    <br>
    <div id="searcher">
        <form>Filter by name: <input type="text" name="value">
            <button type="submit">Search</button>
            <a href="javascript:toggleInfo()" title="Show/hide info" class="codelink"> &#8505; </a>
            <span id="activeSearch" class="hide"> Active filter: <span id="activeSearchTxt"></span></span>
            <div class="hide" id="search_info">
                <ul>
                    <li>Write many words to do an "and" search on the "Name" column</li>
                    <li>Enclose the terms in quotes (") to search them together</li>
                    <li>Add a dash (-) to exclude an expression</li>
                    <li>Search is case insensitive</li>
                    <li>example: <code>"sachusetts mainland" -(ftUS)</code></li>
                </ul>
            </div>
        </form>
    </div>
    <div id="tables"></div>
    <div id="message"><br> >> Select CRS types to display, like Projected, Geographic 2D or Vertical << </div>

    <script>
        let db = null;
        let map = L.map('mapid').setView([0, 0], 1);

        let filters = {
            latlng : null,
            searchText : '',
            ignoreWorld : true,
            hideDeprecated : true,
            authorities : {}
        };

        let marker = null;
        let rectangles = {};
        let hooverRect = null;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);

        map.on('click', function(e) {
            function normalizeLong(lng) {
                while(lng < -180){
                    lng +=360;
                }
                while (lng > 180){
                    lng -= 360;
                }
                return lng;
            }
            filters.latlng = e.latlng;
            if (!marker) {
                marker = L.circleMarker([0,0], {radius:5}).addTo(map);
            }
            marker.setLatLng(filters.latlng);
            filters.latlng.lng = normalizeLong(filters.latlng.lng);
            document.querySelector('#location').innerHTML = 'Clicked location: ' + e.latlng;
            runFilter();
        });

        document.querySelector('#delete').addEventListener('click', function () {
            if (filters.latlng) {
                filters.latlng = null;
                marker.removeFrom(map);
                marker = null;
                document.querySelector('#location').innerHTML = '';
                runFilter();
            }
        });

        document.querySelector('#stickyCb').addEventListener('click', function (ev) {
            document.querySelector('#mapcont').classList[ev.target.checked ? 'add' : 'remove']('sticky');
        });

        function makeRectangle (area_of_use, color) {
            let bounds = null;

            let off0 = 0, off2 = 0;
            if (area_of_use[0] < area_of_use[2]) {
            } else if (Math.abs(area_of_use[0]) < Math.abs(area_of_use[2])) {
                off2 = 360
            } else {
                off0 = 360
            }
            bounds = [[area_of_use[1], area_of_use[0]-off0], [area_of_use[3], area_of_use[2]+off2]];

            return L.rectangle(bounds, {color: color});
        }

        function clickArea(ev, code, area_of_use) {
            if (!(code in rectangles)) {
                rectangles[code] = {layer : makeRectangle(area_of_use, 'green')};
            }
            rectangles[code].layer[ev.target.checked ? 'addTo' : 'removeFrom'](map);
        }

        function mouseOnArea(ev, code, area_of_use, enter) {
            if (hooverRect) {
                hooverRect.removeFrom(map);
                hooverRect = null;
            }
            if (enter) {
                hooverRect = makeRectangle(area_of_use, 'coral');
                hooverRect.addTo(map);
            }
        }

        let tabs = [
            { id:'PROJECTED_CRS', str:'Projected'},
            { id:'GEOGRAPHIC_2D_CRS', str:'Geographic 2D'},
            { id:'GEOGRAPHIC_3D_CRS' , str:'Geographic 3D'},
            { id:'GEOCENTRIC_CRS', str:'Geocentric' },
            { id:'VERTICAL_CRS', str:'Vertical' },
            { id:'COMPOUND_CRS', str:'Compound'},
        ];

        let form = document.querySelector("form");
        form.addEventListener("submit", function(event) {
            event.preventDefault();
            let str = form.elements.value.value.trim();
            filters.searchText = str;

            if (str) {
                document.querySelector('#activeSearch').classList.remove('hide');
                document.querySelector('#activeSearchTxt').innerText = str;
            } else {
                document.querySelector('#activeSearch').classList.add('hide');
            }
            runFilter();
        });

        function toggleInfo() {
            document.querySelector("#search_info").classList.toggle('hide');
        }

        function createLinkMetadataVersion() {
            const version = document.querySelector('#proj_version').innerText;
            document.querySelector('#version_link').innerHTML =
                ` (see <a href="https://github.com/OSGeo/PROJ/blob/${version}/data/sql/metadata.sql" target="_blank">metadata file</a>)`;
        }

        function createTables() {
            tabs.forEach(tab => {
                let tables = document.querySelector('#tables');
                let tabdiv = document.createElement('div');
                tabdiv.id = tab.id + "_DIV";
                tabdiv.classList.add('hide');
                let h3 = document.createElement('h3');
                h3.innerHTML = tab.str;
                h3.appendChild(document.createElement('span'));
                tabdiv.appendChild(h3);
                let tb = document.createElement('table');
                tb.id = tab.id;
                tabdiv.appendChild(tb);
                tables.appendChild(tabdiv);

                const ascCaret = '&#9650;';
                const desCaret = '&#9660;';
                let header = tb.createTHead();
                let row = header.insertRow();
                let order = '<span class="order"></span>';
                ['Code', 'Name', 'Area of Use', 'Deprecated'].forEach(e => row.appendChild(document.createElement('th')).innerHTML = e + order);
                let tblBody = document.createElement('tbody');
                tb.appendChild(tblBody);
                row.querySelector('th').asc = true;
                row.querySelector('.order').innerHTML = ascCaret;

                const getCellValue = (tr, idx) => {
                    let str = tr.children[idx].innerText || tr.children[idx].textContent ;
                    if (idx == 0) {
                        let v = str.split(':');
                        str = v[0] + v[1].padStart(7,'0');
                    }
                    return str;
                };

                const comparer = (idx, asc) => (a, b) => ((v1, v2) =>
                    v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
                    )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

                tb.querySelectorAll('th').forEach(th => th.addEventListener('click', (() => slowTask(() => {
                    header.querySelectorAll('.order').forEach(o => o.innerHTML = '');
                    const idx = Array.from(th.parentNode.children).indexOf(th)
                    Array.from(tblBody.querySelectorAll('tr'))
                        .sort(comparer(idx, th.asc = !th.asc))
                        .forEach(tr => tblBody.appendChild(tr) );
                    colorBackground();
                    th.querySelector('.order').innerHTML = th.asc ? ascCaret : desCaret;
                }))));
            });
        }

        function createCheckboxes() {
            let div = document.querySelector('#filters');
            tabs.forEach(tab => {
                let el = document.createElement('label');
                el.innerHTML = `<input type="checkbox" class="crstype" id="${tab.id}_CB">${tab.str}`;
                div.appendChild(el);
                el.querySelector(`input`).addEventListener('click', function (ev) {
                    slowTask( function() {
                        document.querySelector('#' + tab.id + '_DIV').classList[ev.target.checked ? 'remove' : 'add']('hide');
                    });
                });
            });

            let el = document.createElement('label');
            div.appendChild(el).innerHTML = `<input type="checkbox" id="ignore_world_CB" checked>Ignore World`;
            el.title = "Do not show CRS with area of use longitude from -180 to 180";
            el.querySelector('input').addEventListener('change', function (ev) {
                filters.ignoreWorld = ev.target.checked;
                runFilter();
            });

            let allowdep = document.createElement('label');
            div.appendChild(allowdep).innerHTML = `<input type="checkbox" id="allow_deprecated_CB">Allow deprecated`;
            allowdep.title = "Display also deprecated systems";
            allowdep.querySelector('input').addEventListener('click', function (ev) {
                filters.hideDeprecated = !ev.target.checked;
                runFilter();
            });
        }

        function createAuthorities() {
            let auths = []
            db.forEach(crs => {
                if (!auths.includes(crs.auth_name)) {
                    auths.push(crs.auth_name);
                }
            });
            let div = document.querySelector('#authorities');
            auths.forEach(auth => {
                let el = document.createElement('label');
                el.innerHTML = `<input type="checkbox" id="${auth}" ${auth=="EPSG"?"checked":""}>${auth}`;
                div.appendChild(el);
                filters.authorities[auth] = auth=="EPSG";
                document.querySelector(`#${auth}`).addEventListener('change', function (ev) {
                    filters.authorities[auth] = ev.target.checked;
                    runFilter();
                });
            });
        }

        function slowTask(cb) {
            document.querySelector('.loader-text').classList.remove('hide');
            setTimeout(function() {
                cb();
                document.querySelector('.loader-text').classList.add('hide');
                }, 0);
        }

        function runFilter() {
            slowTask(runFilterCb);
        }

        function runFilterCb() {
            Array.from(document.querySelectorAll(`tbody > tr`)).forEach(r => r.classList.remove('hide'));

            let selectorsArray = [];
            if (filters.searchText) {
                let strs = filters.searchText.match(/(-?".*?"|[^"\s]+)(?=\s*|\s*$)/g); //str.split(' ');
                selectorsArray = strs.map(x => {
                    if (x.charAt(0) == '-') {
                        x = x.replaceAll('"', '');
                        return `[crs_name*="${x.substring(1)}" i]`;
                    } else {
                        x = x.replaceAll('"', '');
                        return `:not([crs_name*="${x}" i])`;
                    }
                });
            }

            if (filters.ignoreWorld) selectorsArray.push('[data-world="true"]');
            if (filters.hideDeprecated) selectorsArray.push('[data-deprecated="true"]');
            Object.keys(filters.authorities).forEach(auth => {
                if (!filters.authorities[auth]) {
                    selectorsArray.push(`[data-auth="${auth}"]`);
                }
            });

            if (selectorsArray.length > 0) {
                const selector = selectorsArray.map(e => `tbody > tr${e}`).join(' , ');
                Array.from(document.querySelectorAll(selector)).forEach(r => r.classList.add('hide'));
            }

            const latlng = filters.latlng;
            if (latlng){
                Array.from(document.querySelectorAll(`tbody > tr:not(.hide)`)).forEach(r => {
                    let use = true;
                    use = latlng.lat >= r.area_of_use[1] && latlng.lat <= r.area_of_use[3];
                    let off0 = 0, off2 = 0;
                    if (r.area_of_use[0] < r.area_of_use[2]) {
                    } else if (latlng.lng > 0){
                        off2 = 360
                    } else {
                        off0 = 360
                    }
                    use = use && latlng.lng >= r.area_of_use[0] - off0 && latlng.lng <= r.area_of_use[2] + off2
                    if (!use) r.classList.add('hide');
                });
            }
            colorBackground();
            countElements();
        }

        function colorBackground() {
            Array.from(document.querySelectorAll(`tbody`)).forEach(tbody => {
                let counter = 0;
                Array.from(tbody.querySelectorAll(`tr:not(.hide)`)).forEach(r => {
                    counter += 1;
                    r.classList[counter % 2 ? 'add' : 'remove']('odd');
                })
            });
        }

        function countElements() {
            tabs.forEach(tab => {
                const c = document.querySelectorAll(`#${tab.id} tbody tr:not(.hide)`).length;
                document.querySelector(`#${tab.id}_DIV h3 span`).innerHTML = " (" + c + ")";
            });
        }

        function fillTables() {
            db.forEach (crs => {
                let code = crs.auth_name + ":" + crs.code;
                let table = document.querySelector('#' + crs.type + ' > tbody');
                let row = table.insertRow();
                row.setAttribute('crs_name', crs.name);
                row.setAttribute('data-type', crs.type);
                row.setAttribute('data-id', code);
                row.setAttribute('data-auth', crs.auth_name);
                row.setAttribute('data-deprecated', crs.deprecated);
                row.setAttribute('data-world', crs.area_of_use[0] == -180 && crs.area_of_use[2] == 180);
                row.area_of_use = crs.area_of_use.slice(0, 4);
                let linkedCode = code;
                if (crs.auth_name == "EPSG") {
                    const scapedName = crs.name.replace(/[^0-9a-zA-Z]+/g, '-');
                    linkedCode = `<a href="https://epsg.org/crs_${crs.code}/${scapedName}.html" target=_blank class="codelink">${code}</a>`;
                }
                row.insertCell().innerHTML = linkedCode;
                row.insertCell().innerHTML = crs.name;
                let area = row.insertCell();
                area.innerHTML = `<label><input type="checkbox"> ${crs.area_of_use[4]}</label>`;
                area.querySelector(`input`).addEventListener('click', function (ev) {clickArea(ev, code, crs.area_of_use)});
                area.title = crs.area_of_use[4];
                area.classList.add('area');
                area.addEventListener('mouseenter', ev => mouseOnArea(ev, code, crs.area_of_use, true));
                area.addEventListener('mouseleave', ev => mouseOnArea(ev, code, crs.area_of_use, false));
                row.insertCell().innerHTML = crs.deprecated;
            });
        }

        function loadDb() {
            let url = 'crslist.json';
            fetch(url, {
                method: "GET",
            })
            .then(response => response.json())
            .then(data => {
                db = data;
                createAuthorities();
                fillTables();
                runFilter();
                // document.querySelector('#PROJECTED_CRS_CB').click(); // select it by default
            });
        }

        function load() {
            setTimeout(function() {
                createLinkMetadataVersion()
                createCheckboxes();
                createTables();
                loadDb();
            }, 1);
        }
    </script>
</body>
</html>
